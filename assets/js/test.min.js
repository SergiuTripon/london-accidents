function init_map(){accidents_map=new google.maps.Map(document.getElementById("map"),{zoom:10,center:london})}function add_year(){$("#map").append("<div id='year-control' class='custom-control'></div>");var a=$("#year-control");a.index(1),accidents_map.controls[google.maps.ControlPosition.TOP_LEFT].push(a[0]),a.append("<div class='header'>2005</div><div class='content'><ul><li>2006</li><li>2007</li><li>2008</li><li>2009</li><li>2010</li><li>2011</li><li>2012</li><li>2013</li><li>2014</li><li>2015</li></ul></div>")}function add_accidents(a){$.ajax({url:"https://api.tfl.gov.uk/AccidentStats/"+a+"?&"+app_id+"&"+app_key}).then(function(a){var b=get_accidents(a);b=get_iw_content(b);var c=new OverlappingMarkerSpiderfier(accidents_map,{keepSpiderfied:!0}),d=create_markers(b,c),e=d[0];c=d[1],create_iw(e,c),create_marker_clusterer(e);var f=get_stats(b);add_stats(f),$("#stats-control .header").click(function(){$content=$(this).next(),$content.toggle()})})}function get_accidents(a){var b=[];return $.each(a,function(a,c){var d={};$.each(c,function(a,b){d[a]=b}),b.push(d)}),b}function get_iw_content(a){var b;return $.each(a,function(c,d){b="<h5>Accident</h5><div><b>Severity</b>: "+d.severity+"<br><b>Borough</b>: "+d.borough+"<br><b>Latitude</b>: "+d.lat+"<br><b>Longitude</b>: "+d.lon+"<br><b>Location</b>: "+d.location+"<br><b>Total casualties</b>: "+d.casualties.length+"<br><b>Total vehicles</b>: "+d.vehicles.length+"<br></div><hr>",d.casualties.length>1?(b+="<h5>Casualties</h5>",$.each(d.casualties,function(a,c){b+="<div><h5>Casualty "+(a+1)+"</h5><b>Age</b>: "+c.age+"<br><b>Class</b>: "+c.class+"<br><b>Severity</b>: "+c.severity+"<br><b>Mode</b>: "+c.mode+"<br><b>Age Band</b>: "+c.ageBand+"<br></div>"})):b+="<h5>Casualty</h5><div><b>Age</b>: "+d.casualties[0].age+"<br><b>Class</b>: "+d.casualties[0].class+"<br><b>Severity</b>: "+d.casualties[0].severity+"<br><b>Mode</b>: "+d.casualties[0].mode+"<br><b>Age Band</b>: "+d.casualties[0].ageBand+"<br></div>",b+="<hr>",d.vehicles.length>1?(b+="<h5>Vehicles</h5>",$.each(d.vehicles,function(a,c){b+="<div><h5>Vehicle "+(a+1)+"</h5><b>Type</b>: "+c.type+"<br></div>"})):b+="<h5>Vehicle</h5><div><b>Type</b>: "+d.vehicles[0].type+"<br></div>",a[c].iw_content=b}),a}function create_markers(a,b){var c=[];return $.each(a,function(a,d){var e=new google.maps.Marker({title:"Location: "+d.location+", Casualties: "+d.accident_casualties+", Vehicles: "+d.accident_vehicles,position:{lat:d.lat,lng:d.lon},category:d.severity,iw_content:d.iw_content});c.push(e),b.addMarker(e),marker_groups[d.severity.toLowerCase()].push(e)}),[c,b]}function create_iw(a,b){var c=new google.maps.InfoWindow;b.addListener("click",function(a,b){c.setContent(a.iw_content),c.open(accidents_map,a)}),b.addListener("spiderfy",function(a){c.close()})}function create_marker_clusterer(a){var b=new MarkerClusterer(accidents_map,a,{imagePath:"../assets/img/m"});return b.setMaxZoom(15),b}function get_stats(a){var b=[],c=[],d=[],e=0,f=0,g=0,h=0,i=0,j=[],k=[],l=[],m=0,n=[],o=0;return $.each(a,function(a,b){d.push(b.severity.toLowerCase()),c.push(b.borough.toLowerCase()),$.each(b.casualties,function(a,b){m+=1,0<=b.age&&b.age<=14?e+=1:15<=b.age&&b.age<=24?f+=1:25<=b.age&&b.age<=54?g+=1:55<=b.age&&b.age<=64?h+=1:65<=b.age&&(i+=1),l.push(b.ageBand.toLowerCase()),k.push(b.class.toLowerCase()),j.push(b.mode.toLowerCase())}),$.each(b.vehicles,function(a,b){o+=1,n.push(b.type)})}),d=count_entities(d),l=count_entities(l),k=count_entities(k),j=count_entities(j),n=count_entities(n),c=count_entities(c),b.push({accidents:{boroughs:c,severities:d,total:a.length},casualties:{ages:{age1:e,age2:f,age3:g,age4:h,age5:i},modes:j,classes:k,ageBands:l,total:m},vehicles:{types:n,total:o}}),b}function count_entities(a){var b={};return $.each(a,function(c,d){b[a[c]]?b[a[c]]++:b[a[c]]=1}),b}function add_stats(a){$("#map").append("<div id='stats-control' class='custom-control'></div>");var b=$("#stats-control");b.index(1),accidents_map.controls[google.maps.ControlPosition.TOP_LEFT].push(b[0]),b.append("<div class='header'>Statistics</div>");var c="<div class='content'>";c+="<h4>Overall</h4><p>Accidents: "+a[0].accidents.total.toLocaleString()+"</p><p>Casualties: "+a[0].casualties.total.toLocaleString()+"</p><p>Vehicles: "+a[0].vehicles.total.toLocaleString()+"</p><hr><h4>Accidents</h4><h5>Severity</h5>",$.each(a[0].accidents.severities,function(a,b){c+="<p>"+a+": "+b.toLocaleString()+"</p>"}),c+="<hr><h4>Casualties</h4><h5>Age</h5><p>0-14: "+a[0].casualties.ages.age1.toLocaleString()+"</p><p>15-24: "+a[0].casualties.ages.age2.toLocaleString()+"</p><p>25-54: "+a[0].casualties.ages.age3.toLocaleString()+"</p><p>55-64: "+a[0].casualties.ages.age4.toLocaleString()+"</p><p>65+: "+a[0].casualties.ages.age5.toLocaleString()+"</p><h5>Age Band</h5>",$.each(a[0].casualties.ageBands,function(a,b){c+="<p>"+a+": "+b.toLocaleString()+"</p>"}),c+="<h5>Class</h5>",$.each(a[0].casualties.classes,function(a,b){c+="<p>"+a+": "+b.toLocaleString()+"</p>"}),c+="<h5>Mode</h5>",$.each(a[0].casualties.modes,function(a,b){c+="<p>"+a+": "+b.toLocaleString()+"</p>"}),c+="<hr><h4>Vehicles</h4><h5>Type</h5>",$.each(a[0].vehicles.types,function(a,b){c+="<p>"+a+": "+b.toLocaleString()+"</p>"}),a.content+="</div>",b.append(c)}var app_id="app_id=ee84c96b",app_key="app_key=3aa60311a1e7234f876e281f65056dbe",year="2005";$(function(){init_map(),add_accidents(year),add_year(),$("#year-control .header").click(function(){$content=$(this).next(),$content.toggle()}),$("#year-control .content li").click(function(){add_accidents($(this).text()),$("#year-control .content").toggle()})});var accidents_map,london={lat:51.5286416,lng:-.1015987},marker_groups={slight:[],serious:[],fatal:[]};