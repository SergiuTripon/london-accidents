var map,oms,marker_cluster,app_id="app_id=ee84c96b",app_key="app_key=3aa60311a1e7234f876e281f65056dbe",zoom=10,london={lat:51.5286416,lng:-.1015987},data_formatted=[],current_year=(new Date).getFullYear(),stats=[],markers=[];function init_map(){map=new google.maps.Map(document.getElementById("map"),{zoom:zoom,center:london})}function set_map_on_all(a){$.each(markers,function(s,t){t.setMap(a)})}function clear_markers(){set_map_on_all(null)}function show_markers(){set_map_on_all(map)}function delete_markers(){clear_markers(),markers=[]}function add_copyright(){var a=document.createElement("div");a.id="copyright";var s=document.createElement("div");s.id="copyright-content",s.innerHTML="<span>Copyright &copy; "+current_year+"<a href='http://sergiu-tripon.com/' target='_blank'> Sergiu Tripon</a></span><span class='hidden-xs'>. Code licensed under <a href='"+license_path+"' target='_blank'>MIT License</a>.</span>",a.appendChild(s),a.index=-1,map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(a)}function add_year_control(a){$("#map").append("<div id='control-year' class='control-custom'>"+a+"</div>");var s=$("#control-year");s.index(1),map.controls[google.maps.ControlPosition.TOP_LEFT].push(s[0]);var t=$("#modal-year"),e="<div class='modal-dialog modal-lg' role='document'>";e+="<div class='modal-content'><div class='modal-header' style='background-color: #EC7063'><div class='container-fluid'><div class='row'><div class='col-lg-12'></div></div></div><button type='button' class='close' data-dismiss='modal' aria-label='Close'><span class='fa fa-times' aria-hidden='true'></span></button></div><div class='modal-body' style='background-color: #45B39D'><div class='container-fluid'><div class='row'><div class='col-lg-12'><ul id='select-year' class='list-inline'>";for(var l=2006;l<=current_year-1;l++)e+="<li class='list-inline-item' id='"+l+"'><button type='button' class='btn btn-light'>"+l+"</button></li>";e+="</ul></div></div></div></div><div class='modal-footer' style='background-color: #EC7063'><div class='container-fluid'><div class='row'><div class='col-lg-12'><button type='button' class='btn btn-light btn-md' data-dismiss='modal'>Close <i class='fa fa-times'></i></button></div></div></div></div></div>",t.append(e),$("#select-year #"+a).remove()}function format_data(a){$.each(a,function(a,s){var t={};$.each(s,function(a,s){t[a]=s}),data_formatted.push(t)})}function get_iw_content(a){var s;$.each(data_formatted,function(t,e){s="<h6 class='mt-3 mb-3'>Accident - "+a+"</h6><div class='pr-4'><b>Severity</b>: "+e.severity+"<br><b>Borough</b>: "+e.borough+"<br><b>Latitude</b>: "+e.lat+"<br><b>Longitude</b>: "+e.lon+"<br><b>Location</b>: "+e.location+"<br><b>Total casualties</b>: "+e.casualties.length+"<br><b>Total vehicles</b>: "+e.vehicles.length+"<br></div><hr>",e.casualties.length>1?(s+="<h6 class='mt-1 mb-3'>Casualties</h6>",$.each(e.casualties,function(a,t){s+="<div class='pr-4'><h6 class='mt-2 mb-1'>Casualty "+(a+1)+"</h6><b>Age</b>: "+t.age+"<br><b>Class</b>: "+t.class+"<br><b>Severity</b>: "+t.severity+"<br><b>Mode</b>: "+t.mode+"<br><b>Age Band</b>: "+t.ageBand+"<br></div>"})):s+="<h6 class='mb-3'>Casualty</h6><div class='pr-4'><b>Age</b>: "+e.casualties[0].age+"<br><b>Class</b>: "+e.casualties[0].class+"<br><b>Severity</b>: "+e.casualties[0].severity+"<br><b>Mode</b>: "+e.casualties[0].mode+"<br><b>Age Band</b>: "+e.casualties[0].ageBand+"<br></div>",s+="<hr>",e.vehicles.length>1?(s+="<h6 class='mt-1 mb-3'>Vehicles</h6>",$.each(e.vehicles,function(a,t){s+="<div class='pr-4'><h6 class='mt-2 mb-1'>Vehicle "+(a+1)+"</h6><b>Type</b>: "+t.type+"<br></div>"})):s+="<h6 class='mb-3'>Vehicle</h6><div class='pr-4'><b>Type</b>: "+e.vehicles[0].type+"<br></div>",data_formatted[t].iw_content=s})}function create_markers(a){oms=new OverlappingMarkerSpiderfier(map,{keepSpiderfied:!0}),$.each(data_formatted,function(s,t){var e=new google.maps.Marker({title:"Year: "+a+", Location: "+t.location+", Casualties: "+t.casualties.length+", Vehicles: "+t.vehicles.length,position:{lat:t.lat,lng:t.lon},category:t.severity,iw_content:t.iw_content});markers.push(e),oms.addMarker(e)});var s=new google.maps.InfoWindow;oms.addListener("click",function(a,t){s.setContent(a.iw_content),s.open(map,a)}),oms.addListener("spiderfy",function(a){s.close()}),(marker_cluster=new MarkerClusterer(map,markers,{imagePath:mc_image_path})).setMaxZoom(15)}function count_entities(a){var s={};return $.each(a,function(t,e){s[a[t]]?s[a[t]]++:s[a[t]]=1}),s}function get_stats(){var a=[],s=[],t=0,e=0,l=0,i=0,o=0,c=[],d=[],n=[],r=0,v=[],m=0;$.each(data_formatted,function(h,u){s.push(u.severity.toLowerCase()),a.push(u.borough.toLowerCase()),$.each(u.casualties,function(a,s){r+=1,0<=s.age&&s.age<=14?t+=1:15<=s.age&&s.age<=24?e+=1:25<=s.age&&s.age<=54?l+=1:55<=s.age&&s.age<=64?i+=1:65<=s.age&&(o+=1),n.push(s.ageBand),d.push(s.class),c.push(s.mode)}),$.each(u.vehicles,function(a,s){m+=1,v.push(s.type)})}),s=count_entities(s),n=count_entities(n),d=count_entities(d),c=count_entities(c),v=count_entities(v),a=count_entities(a),stats.push({accidents:{boroughs:a,severities:s,total:data_formatted.length},casualties:{ages:{age1:t,age2:e,age3:l,age4:i,age5:o},modes:c,classes:d,ageBands:n,total:r},vehicles:{types:v,total:m}})}function add_stats_control(a){$("#map").append("<div id='control-stats' class='control-custom'>Stats</div>");var s=$("#control-stats");s.index(1),map.controls[google.maps.ControlPosition.TOP_LEFT].push(s[0]);var t=$("#modal-stats"),e="<div class='modal-dialog modal-lg' role='document'>";e+="<div class='modal-content'><div class='modal-header' style='background-color: #EC7063'><div class='container-fluid'><div class='row'><div class='col-lg-12'><h2>- London Accidents -<br>"+a+" Statistics</h2></div></div></div><button type='button' class='close' data-dismiss='modal' aria-label='Close'><span class='fa fa-times' aria-hidden='true'></span></button></div>",e+="<div class='modal-body' style='background-color: #45B39D'><div class='container-fluid'><div class='row'><div class='col-lg-12'>",e+="<div class='col-lg-12'><h3 class='mt-3'>Overall</h3></div><div class='row'><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h5>Accidents</h5><h5>"+stats[0].accidents.total.toLocaleString()+"</h5></div></div><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h5>Casualties</h5><h5>"+stats[0].casualties.total.toLocaleString()+"</h5></div></div><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h5>Vehicles</h5><h5>"+stats[0].vehicles.total.toLocaleString()+"</h5></div></div></div></div></div></div></div><hr>",e+="<div class='modal-body' style='background-color: #5DADE2'><div class='container-fluid'><div class='row'><div class='col-lg-12'><h3 class='mt-3'>Accidents</h3><h4 class='mt-4 mb-3'>Severity</h4></div>",$.each(stats[0].accidents.severities,function(a,s){e+="<div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h5>"+a+"</h5><h5>"+s.toLocaleString()+"</h5></div></div>"}),e+="<div class='col-lg-12'><h4 class='mt-4 mb-3'>Borough</h4></div>",$.each(stats[0].accidents.boroughs,function(a,s){e+="<div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h5>"+a+"</h5><h5>"+s.toLocaleString()+"</h5></div></div>"}),e+="</div></div></div><hr>",e+="<div class='modal-body' style='background-color: #2ECC71'><div class='container-fluid'><div class='row'><div class='col-lg-12'><h3 class='mt-3'>Casualties</h3><h4 class='mt-4 mb-3'>Age</h4></div><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h5>0-14</h5><h5>"+stats[0].casualties.ages.age1.toLocaleString()+"</h5></div></div><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h5>15-24</h5><h5>"+stats[0].casualties.ages.age2.toLocaleString()+"</h5></div></div><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h5>25-54</h5><h5>"+stats[0].casualties.ages.age3.toLocaleString()+"</h5></div></div><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h5>55-64</h5><h5>"+stats[0].casualties.ages.age4.toLocaleString()+"</h5></div></div><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h5>65+</h5><h5>"+stats[0].casualties.ages.age5.toLocaleString()+"</h5></div></div><div class='col-lg-12'><h4 class='mt-4 mb-3'>Age Band</h4></div>",$.each(stats[0].casualties.ageBands,function(a,s){e+="<div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h5>"+a+"</h5><h5>"+s.toLocaleString()+"</h5></div></div>"}),e+="<div class='col-lg-12'><h4 class='mt-4 mb-3'>Class</h4></div>",$.each(stats[0].casualties.classes,function(a,s){e+="<div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h5>"+a+"</h5><h5>"+s.toLocaleString()+"</h5></div></div>"}),e+="<div class='col-lg-12'><h4>Mode</h4></div>",$.each(stats[0].casualties.modes,function(a,s){e+="<div class='col-sm-6 col-md-4 col-lg-4'><div class='item-stats'><h5>"+a.split(/(?=[A-Z])/).join(" ")+"</h5><h5>"+s.toLocaleString()+"</h5></div></div>"}),e+="</div></div></div><hr>",e+="<div class='modal-body' style='background-color: #F5B041'><div class='container-fluid'><div class='row'><div class='col-lg-12'><h3 class='mt-3'>Vehicles</h3><h4 class='mt-4 mb-3'>Type</h4></div>",$.each(stats[0].vehicles.types,function(a,s){e+="<div class='col-sm-6 col-md-4 col-lg-4'><div class='item-stats'><h5>"+a.split(/(?=[A-Z])/).join(" ")+"</h5><h5>"+s.toLocaleString()+"</h5></div></div>"}),e+="</div></div></div>",e+="<div class='modal-footer' style='background-color: #EC7063'><div class='container-fluid'><div class='row'><div class='col-lg-12'><button type='button' class='btn btn-light btn-md' data-dismiss='modal'>Close <i class='fa fa-times'></i></button></div></div></div></div></div>",t.append(e)}function get_data(a){$.ajax({url:"https://api.tfl.gov.uk/AccidentStats/"+a+"?&"+app_id+"&"+app_key}).then(function(s){format_data(s),get_iw_content(a),create_markers(a),get_stats(),add_year_control(a),add_stats_control(a),$("#control-year").click(function(){$("#modal-year").modal("show")}),$("#control-stats").click(function(){$("#modal-stats").modal("show")}),$("#modal-year li button").click(function(){$("#modal-year").modal("hide"),marker_cluster.clearMarkers(),oms.clearMarkers(),delete_markers(),data_formatted=[],stats=[],$("#modal-stats .modal-dialog").remove(),$("#modal-year .modal-dialog").remove(),$("#control-stats").remove(),$("#control-year").remove();var a=$(this).text();Pace.restart(),get_data(a),map.setCenter(london),map.setZoom(zoom)})}).fail(function(){var s=parseInt(a);get_data(s+1===current_year?(s-1).toString():(s+1).toString())})}$(function(){init_map(),add_copyright(),get_data("2005")});