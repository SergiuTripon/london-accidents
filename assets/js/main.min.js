function init_map(){map=new google.maps.Map(document.getElementById("map"),{zoom:zoom,center:london})}function set_map_on_all(a){$.each(markers,function(b,c){c.setMap(a)})}function clear_markers(){set_map_on_all(null)}function show_markers(){set_map_on_all(map)}function delete_markers(){clear_markers(),markers=[]}function add_copyright(){var a=document.createElement("div");a.id="copyright";var b=document.createElement("div");b.id="copyright-content",b.innerHTML="<span>Copyright &copy; "+current_year+"<a href='http://sergiu-tripon.com/' target='_blank'> Sergiu Tripon</a></span><span class='hidden-xs'>. Code licensed under <a href='"+license_path+"' target='_blank'>MIT License</a>.</span>",a.appendChild(b),a.index=-1,map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(a)}function add_year_control(a){$("#map").append("<div id='control-year' class='control-custom'>"+a+"</div>");var b=$("#control-year");b.index(1),map.controls[google.maps.ControlPosition.TOP_LEFT].push(b[0]);var c=$("#modal-year"),d="<div class='modal-dialog modal-md' role='document'>";d+="<div class='modal-content'><div class='modal-header' style='background-color: #EC7063'><button type='button' class='close' data-dismiss='modal' aria-label='Close'><span class='fa fa-times' aria-hidden='true'></span></button><div class='container-fluid'><div class='row'><div class='col-lg-12'></div></div></div></div><div class='modal-body' style='background-color: #45B39D'><div class='container-fluid'><div class='row'><div class='col-lg-12'><ul id='select-year' class='list-inline'>";for(var e=2006;e<=current_year-1;e++)d+="<li id='"+e+"'><button type='button' class='btn btn-light'>"+e+"</button></li>";d+="</ul></div></div></div></div><div class='modal-footer' style='background-color: #EC7063'><div class='container-fluid'><div class='row'><div class='col-lg-12'><button type='button' class='btn btn-light btn-md' data-dismiss='modal'>Close <i class='fa fa-times'></i></button></div></div></div></div></div>",c.append(d),$("#select-year #"+a).remove()}function format_data(a){$.each(a,function(a,b){var c={};$.each(b,function(a,b){c[a]=b}),data_formatted.push(c)})}function get_iw_content(a){var b;$.each(data_formatted,function(c,d){b="<h5>Accident - "+a+"</h5><div><b>Severity</b>: "+d.severity+"<br><b>Borough</b>: "+d.borough+"<br><b>Latitude</b>: "+d.lat+"<br><b>Longitude</b>: "+d.lon+"<br><b>Location</b>: "+d.location+"<br><b>Total casualties</b>: "+d.casualties.length+"<br><b>Total vehicles</b>: "+d.vehicles.length+"<br></div><hr>",d.casualties.length>1?(b+="<h5>Casualties</h5>",$.each(d.casualties,function(a,c){b+="<div><h5>Casualty "+(a+1)+"</h5><b>Age</b>: "+c.age+"<br><b>Class</b>: "+c.class+"<br><b>Severity</b>: "+c.severity+"<br><b>Mode</b>: "+c.mode+"<br><b>Age Band</b>: "+c.ageBand+"<br></div>"})):b+="<h5>Casualty</h5><div><b>Age</b>: "+d.casualties[0].age+"<br><b>Class</b>: "+d.casualties[0].class+"<br><b>Severity</b>: "+d.casualties[0].severity+"<br><b>Mode</b>: "+d.casualties[0].mode+"<br><b>Age Band</b>: "+d.casualties[0].ageBand+"<br></div>",b+="<hr>",d.vehicles.length>1?(b+="<h5>Vehicles</h5>",$.each(d.vehicles,function(a,c){b+="<div><h5>Vehicle "+(a+1)+"</h5><b>Type</b>: "+c.type+"<br></div>"})):b+="<h5>Vehicle</h5><div><b>Type</b>: "+d.vehicles[0].type+"<br></div>",data_formatted[c].iw_content=b})}function create_markers(a){oms=new OverlappingMarkerSpiderfier(map,{keepSpiderfied:!0}),$.each(data_formatted,function(b,c){var d=new google.maps.Marker({title:"Year: "+a+", Location: "+c.location+", Casualties: "+c.casualties.length+", Vehicles: "+c.vehicles.length,position:{lat:c.lat,lng:c.lon},category:c.severity,iw_content:c.iw_content});markers.push(d),oms.addMarker(d)});var b=new google.maps.InfoWindow;oms.addListener("click",function(a,c){b.setContent(a.iw_content),b.open(map,a)}),oms.addListener("spiderfy",function(a){b.close()}),marker_cluster=new MarkerClusterer(map,markers,{imagePath:mc_image_path}),marker_cluster.setMaxZoom(15)}function count_entities(a){var b={};return $.each(a,function(c,d){b[a[c]]?b[a[c]]++:b[a[c]]=1}),b}function get_stats(){var a=[],b=[],c=0,d=0,e=0,f=0,g=0,h=[],i=[],j=[],k=0,l=[],m=0;$.each(data_formatted,function(n,o){b.push(o.severity.toLowerCase()),a.push(o.borough.toLowerCase()),$.each(o.casualties,function(a,b){k+=1,0<=b.age&&b.age<=14?c+=1:15<=b.age&&b.age<=24?d+=1:25<=b.age&&b.age<=54?e+=1:55<=b.age&&b.age<=64?f+=1:65<=b.age&&(g+=1),j.push(b.ageBand),i.push(b.class),h.push(b.mode)}),$.each(o.vehicles,function(a,b){m+=1,l.push(b.type)})}),b=count_entities(b),j=count_entities(j),i=count_entities(i),h=count_entities(h),l=count_entities(l),a=count_entities(a),stats.push({accidents:{boroughs:a,severities:b,total:data_formatted.length},casualties:{ages:{age1:c,age2:d,age3:e,age4:f,age5:g},modes:h,classes:i,ageBands:j,total:k},vehicles:{types:l,total:m}})}function add_stats_control(a){$("#map").append("<div id='control-stats' class='control-custom'>Stats</div>");var b=$("#control-stats");b.index(1),map.controls[google.maps.ControlPosition.TOP_LEFT].push(b[0]);var c=$("#modal-stats"),d="<div class='modal-dialog modal-lg' role='document'>";d+="<div class='modal-content'><div class='modal-header' style='background-color: #EC7063'><button type='button' class='close' data-dismiss='modal' aria-label='Close'><span class='fa fa-times' aria-hidden='true'></span></button><div class='container-fluid'><div class='row'><div class='col-lg-12'><h1>- London Accidents -<br>"+a+" Statistics</h1></div></div></div></div>",d+="<div class='modal-body' style='background-color: #45B39D'><div class='container-fluid'><div class='row'><div class='col-lg-12'>",d+="<div class='col-lg-12'><h2>Overall</h2></div><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h4>Accidents</h4><h4>"+stats[0].accidents.total.toLocaleString()+"</h4></div></div><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h4>Casualties</h4><h4>"+stats[0].casualties.total.toLocaleString()+"</h4></div></div><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h4>Vehicles</h4><h4>"+stats[0].vehicles.total.toLocaleString()+"</h4></div></div></div></div></div></div><hr>",d+="<div class='modal-body' style='background-color: #5DADE2'><div class='container-fluid'><div class='row'><div class='col-lg-12'><div class='col-lg-12'><h2>Accidents</h2><h3>Severity</h3></div>",$.each(stats[0].accidents.severities,function(a,b){d+="<div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h4>"+a+"</h4><h4>"+b.toLocaleString()+"</h4></div></div>"}),d+="<div class='col-lg-12'><h3>Borough</h3></div>",$.each(stats[0].accidents.boroughs,function(a,b){d+="<div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h4>"+a+"</h4><h4>"+b.toLocaleString()+"</h4></div></div>"}),d+="</div></div></div></div><hr>",d+="<div class='modal-body' style='background-color: #2ECC71'><div class='container-fluid'><div class='row'><div class='col-lg-12'><h2>Casualties</h2><h3>Age</h3></div><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h4>0-14</h4><h4>"+stats[0].casualties.ages.age1.toLocaleString()+"</h4></div></div><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h4>15-24</h4><h4>"+stats[0].casualties.ages.age2.toLocaleString()+"</h4></div></div><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h4>25-54</h4><h4>"+stats[0].casualties.ages.age3.toLocaleString()+"</h4></div></div><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h4>55-64</h4><h4>"+stats[0].casualties.ages.age4.toLocaleString()+"</h4></div></div><div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h4>65+</h4><h4>"+stats[0].casualties.ages.age5.toLocaleString()+"</h4></div></div><div class='col-lg-12'><h3>Age Band</h3></div>",$.each(stats[0].casualties.ageBands,function(a,b){d+="<div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h4>"+a+"</h4><h4>"+b.toLocaleString()+"</h4></div></div>"}),d+="<div class='col-lg-12'><h3>Class</h3></div>",$.each(stats[0].casualties.classes,function(a,b){d+="<div class='col-sm-4 col-md-4 col-lg-4'><div class='item-stats'><h4>"+a+"</h4><h4>"+b.toLocaleString()+"</h4></div></div>"}),d+="<div class='col-lg-12'><h3>Mode</h3></div>",$.each(stats[0].casualties.modes,function(a,b){d+="<div class='col-sm-6 col-md-4 col-lg-4'><div class='item-stats'><h4>"+a.split(/(?=[A-Z])/).join(" ")+"</h4><h4>"+b.toLocaleString()+"</h4></div></div>"}),d+="</div></div></div><hr>",d+="<div class='modal-body' style='background-color: #F5B041'><div class='container-fluid'><div class='row'><div class='col-lg-12'><div class='col-lg-12'><h2>Vehicles</h2><h3>Type</h3></div>",$.each(stats[0].vehicles.types,function(a,b){d+="<div class='col-sm-6 col-md-4 col-lg-4'><div class='item-stats'><h4>"+a.split(/(?=[A-Z])/).join(" ")+"</h4><h4>"+b.toLocaleString()+"</h4></div></div>"}),d+="</div></div></div></div>",d+="<div class='modal-footer' style='background-color: #EC7063'><div class='container-fluid'><div class='row'><div class='col-lg-12'><button type='button' class='btn btn-light btn-md' data-dismiss='modal'>Close <i class='fa fa-times'></i></button></div></div></div></div></div>",c.append(d)}function get_data(a){$.ajax({url:"https://api.tfl.gov.uk/AccidentStats/"+a+"?&"+app_id+"&"+app_key}).then(function(b){format_data(b),get_iw_content(a),create_markers(a),get_stats(),add_year_control(a),add_stats_control(a),$("#control-year").click(function(){$("#modal-year").modal("show")}),$("#control-stats").click(function(){$("#modal-stats").modal("show")}),$("#modal-year li button").click(function(){$("#modal-year").modal("hide"),marker_cluster.clearMarkers(),oms.clearMarkers(),delete_markers(),data_formatted=[],stats=[],$("#modal-stats .modal-dialog").remove(),$("#modal-year .modal-dialog").remove(),$("#control-stats").remove(),$("#control-year").remove();var a=$(this).text();Pace.restart(),get_data(a),map.setCenter(london),map.setZoom(zoom)})}).fail(function(){get_data((parseInt(a)+1).toString())})}var app_id="app_id=ee84c96b",app_key="app_key=3aa60311a1e7234f876e281f65056dbe",map,zoom=10,london={lat:51.5286416,lng:-.1015987},data_formatted=[],current_year=(new Date).getFullYear(),stats=[],markers=[],oms,marker_cluster;$(function(){init_map(),add_copyright(),get_data("2005")});